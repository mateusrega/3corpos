<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Simulação – Três Corpos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
    touch-action: none;
    font-family: sans-serif;
    color: white;
  }

  #canvas {
    width: 100vw;
    height: 100vh;
    display: block;
    touch-action: none;
  }

  #uiBtn {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 15;
    background: #333;
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 16px;
    color: white;
  }

  #panel {
    position: absolute;
    top:0;
    right:0;
    width:260px;
    background:#111;
    color:white;
    padding:16px;
    border-left:2px solid #222;
    height:100%;
    display:none;
    z-index:20;
  }

  #panel input, #panel button {
    width: 100%;
    margin: 4px 0 12px 0;
    padding: 6px;
    font-size: 15px;
    border-radius: 6px;
    border: none;
  }

  #panel button {
    background: #4caf50;
    color: white;
  }

  .small {
    font-size: 12px;
    opacity: .7;
    margin-bottom: 10px;
  }

  .footer {
    position: absolute;
    bottom: 10px;
    width: 100%;
    text-align: center;
    color: #aaa;
    font-size: 13px;
    pointer-events:none;
  }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<button id="uiBtn">⚙ Configurar</button>

<!-- Painel lateral com botão de fechar -->
<aside id="panel" aria-hidden="true">

  <button id="closePanel" style="
    position:absolute;
    top:8px;
    right:8px;
    background:#ef4444;
    border:none;
    color:white;
    padding:4px 10px;
    font-size:16px;
    border-radius:6px;">X</button>

  <h3 style="margin:0 0 6px 0;">Criar corpo</h3>

  <label>Massa</label>
  <input id="massa" type="number" value="20" step="1" min="0.1">

  <label>Pos X</label>
  <input id="posX" type="number" value="-150">

  <label>Pos Y</label>
  <input id="posY" type="number" value="0">

  <label>Vel X</label>
  <input id="velX" type="number" value="0">

  <label>Vel Y</label>
  <input id="velY" type="number" value="1.2">

  <button id="addBtn">Adicionar corpo</button>

  <div class="small">Toque na tela e arraste: início = posição, arrasto = velocidade.</div>

  <hr style="border:none; border-top:1px solid #333; margin:12px 0">

  <label>Constante G</label>
  <input id="gRange" type="range" min="0.01" max="1.0" step="0.01" value="0.20">
  <div id="gVal" class="small">G = 0.20</div>

  <label>Time-step (dt)</label>
  <input id="dtRange" type="range" min="0.1" max="2" step="0.1" value="0.9">
  <div id="dtVal" class="small">dt = 0.90</div>

  <button id="resetBtn" style="background:#ef4444;">Resetar cena</button>
</aside>

<div class="footer">Rastro ≤ 450 pontos • Pinch-to-zoom & pan (mobile)</div>


<script>
// -----------------------------------------------------------
// Variáveis principais
// -----------------------------------------------------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

let bodies = [];
let trails = [];

let G = 0.20;
let dt = 0.90;

let camX = 0;
let camY = 0;
let zoom = 1;

const MAX_TRAIL = 450;

// -----------------------------------------------------------
// Corpo celeste
// -----------------------------------------------------------
class Body {
  constructor(x, y, vx, vy, m) {
    this.x = x;
    this.y = y;
    this.vx = vx;
    this.vy = vy;
    this.m = m;

    this.color = getColorByMass(m);
    this.ax = 0;
    this.ay = 0;
  }
}

// -----------------------------------------------------------
// Cor por massa
// -----------------------------------------------------------
function getColorByMass(m) {
  const t = Math.min(1, Math.max(0, (m - 1) / 100));
  const hue = 240 - 240 * t;
  return `hsl(${hue}, 80%, 60%)`;
}

// -----------------------------------------------------------
// Dinâmica – Velocity Verlet
// -----------------------------------------------------------
function computeGravity() {
  for (let b of bodies) b.ax = b.ay = 0;

  for (let i = 0; i < bodies.length; i++) {
    for (let j = i + 1; j < bodies.length; j++) {
      const a = bodies[i], b = bodies[j];

      let dx = b.x - a.x;
      let dy = b.y - a.y;

      let r2 = dx*dx + dy*dy + 0.01;
      let r = Math.sqrt(r2);
      let f = G / r2;

      let fx = f * dx / r;
      let fy = f * dy / r;

      a.ax += fx * b.m;
      a.ay += fy * b.m;

      b.ax -= fx * a.m;
      b.ay -= fy * a.m;
    }
  }
}

function updateBodies() {
  computeGravity();

  for (let b of bodies) {
    b.vx += b.ax * dt;
    b.vy += b.ay * dt;
    b.x += b.vx * dt;
    b.y += b.vy * dt;
  }
}

// -----------------------------------------------------------
// Renderização
// -----------------------------------------------------------
function worldToScreen(x, y) {
  return [
    (x - camX) * zoom + W/2,
    (y - camY) * zoom + H/2
  ];
}

function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,W,H);

  bodies.forEach((b, i) => {
    const [sx, sy] = worldToScreen(b.x, b.y);

    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.arc(sx, sy, 6 * zoom, 0, 2*Math.PI);
    ctx.fill();

    if (!trails[i]) trails[i] = [];
    trails[i].push([sx, sy]);
    if (trails[i].length > MAX_TRAIL) trails[i].shift();

    ctx.strokeStyle = b.color + "88";
    ctx.beginPath();
    for (let p = 0; p < trails[i].length; p++) {
      const [tx, ty] = trails[i][p];
      p === 0 ? ctx.moveTo(tx, ty) : ctx.lineTo(tx, ty);
    }
    ctx.stroke();
  });
}

// -----------------------------------------------------------
// Loop
// -----------------------------------------------------------
function loop() {
  updateBodies();
  draw();
  requestAnimationFrame(loop);
}
loop();

// -----------------------------------------------------------
// Painel
// -----------------------------------------------------------
document.getElementById("uiBtn").onclick = () => {
  panel.style.display = "block";
};
document.getElementById("closePanel").onclick = () => {
  panel.style.display = "none";
};

document.getElementById("gRange").oninput = e => {
  G = parseFloat(e.target.value);
  gVal.textContent = "G = " + G.toFixed(2);
};
document.getElementById("dtRange").oninput = e => {
  dt = parseFloat(e.target.value);
  dtVal.textContent = "dt = " + dt.toFixed(2);
};

document.getElementById("addBtn").onclick = () => {
  const m = parseFloat(massa.value);
  const x = parseFloat(posX.value);
  const y = parseFloat(posY.value);
  const vx = parseFloat(velX.value);
  const vy = parseFloat(velY.value);

  bodies.push(new Body(x, y, vx, vy, m));
};

document.getElementById("resetBtn").onclick = () => {
  bodies = [];
  trails = [];
};

// -----------------------------------------------------------
// Mobile: zoom e pan
// -----------------------------------------------------------
let lastTouches = null;

canvas.addEventListener("touchmove", ev => {
  ev.preventDefault();

  if (ev.touches.length === 1 && lastTouches) {
    const dx = ev.touches[0].clientX - lastTouches[0].clientX;
    const dy = ev.touches[0].clientY - lastTouches[0].clientY;

    camX -= dx / zoom;
    camY -= dy / zoom;
  }

  if (ev.touches.length === 2) {
    let t1 = ev.touches[0];
    let t2 = ev.touches[1];
    let lt1 = lastTouches[0];
    let lt2 = lastTouches[1];

    let dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
    let lastDist = Math.hypot(lt2.clientX - lt1.clientX, lt2.clientY - lt1.clientY);

    zoom *= dist / lastDist;
  }

  lastTouches = [...ev.touches];
});

canvas.addEventListener("touchend", () => {
  lastTouches = null;
});
</script>

</body>
</html>
