<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>3-Corpos — Mobile</title>

<style>
  :root { --bg:#000; --panel:#0f1720; --accent:#0a84ff; --ui:#ddd; }

  html, body {
    margin: 0;
    height: 100%;
    background: var(--bg);
    color: var(--ui);
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
    overflow: hidden;
    font-family: system-ui, Arial;
  }

  #canvas {
    display: block;
    width: 100vw;
    height: 100vh;
  }

  /* BOTÃO DE ABRIR PAINEL */
  #uiBtn {
    position: fixed;
    left: 12px;
    top: 12px;
    z-index: 30;
    background: rgba(255,255,255,0.08);
    border: 0;
    color: var(--ui);
    padding: 10px 12px;
    border-radius: 50%;
    font-size: 20px;
  }

  /* PAINEL LATERAL */
  #panel {
    position: fixed;
    right: -320px;
    top: 0;
    width: 300px;
    height: 100vh;
    background: var(--panel);
    box-sizing: border-box;
    padding: 20px;
    transition: right .28s ease;
    z-index: 40;
  }

  #panel.open {
    right: 0;
  }

  /* FECHAR PAINEL */
  #closePanel {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ef4444;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    font-size: 20px;
    cursor: pointer;
  }

  label {
    display: block;
    margin-top: 12px;
    font-size: 13px;
    color: #cbd5e1;
  }

  input[type="number"], input[type="range"] {
    width: 100%;
    margin-top: 6px;
    padding: 8px;
    border-radius: 6px;
    border: 0;
    background: #0b1220;
    color: var(--ui);
  }

  button {
    margin-top: 12px;
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 0;
    background: var(--accent);
    color: white;
    font-weight: 700;
  }

  .small {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 6px;
  }

  .footer {
    position: fixed;
    right: 12px;
    bottom: 12px;
    z-index: 20;
    background: rgba(255,255,255,0.05);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    color: #9ca3af;
  }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<button id="uiBtn">⚙</button>

<aside id="panel" aria-hidden="true">
  <button id="closePanel">×</button>

  <h3 style="margin:0 0 6px 0;">Criar corpo</h3>

  <label>Massa</label>
  <input id="massa" type="number" value="20" min="0.1" step="1">

  <label>Pos X</label>
  <input id="posX" type="number" value="-150">

  <label>Pos Y</label>
  <input id="posY" type="number" value="0">

  <label>Vel X</label>
  <input id="velX" type="number" value="0">

  <label>Vel Y</label>
  <input id="velY" type="number" value="1.2">

  <button id="addBtn">Adicionar corpo</button>

  <div class="small">Toque e arraste para criar um corpo (pos → velocidade).</div>

  <hr style="margin:12px 0; border:none; border-top:1px solid rgba(255,255,255,0.06)">

  <label>Constante G</label>
  <input id="gRange" type="range" min="0.01" max="1.00" step="0.01" value="0.2">
  <div id="gVal" class="small">G = 0.20</div>

  <label>Time-step</label>
  <input id="dtRange" type="range" min="0.1" max="2.0" step="0.1" value="0.9">
  <div id="dtVal" class="small">dt = 0.90</div>

  <button id="resetBtn" style="background:#ef4444;">Resetar Cena</button>
</aside>

<div class="footer">Rastro limitado a 450 px • Pinch zoom + pan</div>

<script>
/* ============================================================
    SETUP CANVAS
============================================================ */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = innerWidth * dpr;
  canvas.height = innerHeight * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener("resize", resize);
resize();

/* ============================================================
    CÂMERA
============================================================ */
let camX = 0, camY = 0;
let camZoom = 1;

function worldToScreen(x, y) {
  return [
    (x - camX) * camZoom + innerWidth / 2,
    (y - camY) * camZoom + innerHeight / 2
  ];
}

function screenToWorld(x, y) {
  return [
    (x - innerWidth / 2) / camZoom + camX,
    (y - innerHeight / 2) / camZoom + camY
  ];
}

/* ============================================================
    SIMULAÇÃO
============================================================ */
const bodies = [];
let G = 0.2;
let dt = 0.9;

function createBody(m, x, y, vx, vy) {
  bodies.push({
    m, x, y,
    vx, vy,
    ax: 0, ay: 0,
    trail: [],
    color: pickColor(m)
  });
}

function pickColor(m) {
  if (m < 10) return "#4ade80";
  if (m < 30) return "#60a5fa";
  if (m < 80) return "#facc15";
  return "#f87171";
}

/* ============================================================
    FÍSICA – VERLET
============================================================ */
function computeForces() {
  for (let b of bodies) { b.ax = 0; b.ay = 0; }

  for (let i = 0; i < bodies.length; i++) {
    for (let j = i+1; j < bodies.length; j++) {

      let bi = bodies[i], bj = bodies[j];
      let dx = bj.x - bi.x;
      let dy = bj.y - bi.y;
      let dist = Math.hypot(dx, dy) + 0.1;

      let f = G / (dist * dist);

      bi.ax += f * bj.m * dx / dist;
      bi.ay += f * bj.m * dy / dist;

      bj.ax -= f * bi.m * dx / dist;
      bj.ay -= f * bi.m * dy / dist;
    }
  }
}

function step() {
  computeForces();

  for (let b of bodies) {
    b.vx += b.ax * dt;
    b.vy += b.ay * dt;
    b.x += b.vx * dt;
    b.y += b.vy * dt;

    b.trail.push([b.x, b.y]);
    if (b.trail.length > 600) b.trail.shift();
  }
}

/* ============================================================
    RASTRO COM LIMITE DE 450 PX
============================================================ */
const TRAIL_MAX_PX = 450;

function drawTrail(b) {
  let total = 0;
  let t = b.trail;
  let trimmed = [];

  for (let i = t.length - 1; i > 0; i--) {
    let [x1, y1] = worldToScreen(t[i][0], t[i][1]);
    let [x2, y2] = worldToScreen(t[i-1][0], t[i-1][1]);

    let d = Math.hypot(x2 - x1, y2 - y1);
    total += d;

    trimmed.unshift(t[i]);
    if (total > TRAIL_MAX_PX) break;
  }

  trimmed.push(t[t.length - 1]);

  ctx.beginPath();
  for (let i = 0; i < trimmed.length; i++) {
    let [sx, sy] = worldToScreen(trimmed[i][0], trimmed[i][1]);
    if (i === 0) ctx.moveTo(sx, sy);
    else ctx.lineTo(sx, sy);
  }
  ctx.strokeStyle = b.color;
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

/* ============================================================
    DESENHO
============================================================ */
function draw() {
  ctx.clearRect(0, 0, innerWidth, innerHeight);

  for (let b of bodies) drawTrail(b);

  for (let b of bodies) {
    let [sx, sy] = worldToScreen(b.x, b.y);
    let r = Math.max(3, Math.sqrt(b.m) * camZoom * 0.4);

    ctx.beginPath();
    ctx.arc(sx, sy, r, 0, Math.PI * 2);
    ctx.fillStyle = b.color;
    ctx.fill();
  }
}

/* ============================================================
    LOOP (APENAS UM!)
============================================================ */
function loop() {
  step();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ============================================================
    TOQUE: criar corpo / pan / pinch zoom
============================================================ */
let touch1 = null, touch2 = null;
let dragging = false;
let dragStartWorld = null;

canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    let t = e.touches[0];
    let w = screenToWorld(t.clientX, t.clientY);
    dragging = true;
    dragStartWorld = w;
  }
  else if (e.touches.length === 2) {
    touch1 = e.touches[0];
    touch2 = e.touches[1];
  }
});

canvas.addEventListener("touchmove", e => {
  if (e.touches.length === 2) {
    let t1 = e.touches[0], t2 = e.touches[1];

    let dx1 = t1.clientX - touch1.clientX;
    let dy1 = t1.clientY - touch1.clientY;

    camX -= dx1 / camZoom;
    camY -= dy1 / camZoom;

    let dOld = Math.hypot(
      touch2.clientX - touch1.clientX,
      touch2.clientY - touch1.clientY
    );
    let dNew = Math.hypot(
      t2.clientX - t1.clientX,
      t2.clientY - t1.clientY
    );

    camZoom *= dNew / dOld;

    touch1 = t1;
    touch2 = t2;
  }
});

canvas.addEventListener("touchend", e => {
  if (dragging && e.changedTouches.length === 1) {
    let t = e.changedTouches[0];
    let end = screenToWorld(t.clientX, t.clientY);

    let vx = (end[0] - dragStartWorld[0]) * 0.05;
    let vy = (end[1] - dragStartWorld[1]) * 0.05;

    createBody(
      parseFloat(massa.value),
      dragStartWorld[0],
      dragStartWorld[1],
      vx,
      vy
    );
  }

  dragging = false;
});

/* ============================================================
    UI DO PAINEL
============================================================ */
const uiBtn = document.getElementById("uiBtn");
const panel = document.getElementById("panel");
const closePanel = document.getElementById("closePanel");

uiBtn.onclick = () => panel.classList.add("open");
closePanel.onclick = () => panel.classList.remove("open");

document.getElementById("gRange").oninput = e => {
  G = parseFloat(e.target.value);
  gVal.textContent = "G = " + G.toFixed(2);
};

document.getElementById("dtRange").oninput = e => {
  dt = parseFloat(e.target.value);
  dtVal.textContent = "dt = " + dt.toFixed(2);
};

document.getElementById("addBtn").onclick = () => {
  createBody(
    parseFloat(massa.value),
    parseFloat(posX.value),
    parseFloat(posY.value),
    parseFloat(velX.value),
    parseFloat(velY.value)
  );
};

document.getElementById("resetBtn").onclick = () => {
  bodies.length = 0;
};

</script>
</body>
</html>
