<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>3-Corpos — Mobile (Verlet + Pinch Zoom)</title>
<style>
  :root { --bg:#000; --panel:#0f1720; --accent:#0a84ff; --ui:#ddd; }
  html,body{height:100%;margin:0;padding:0;background:var(--bg);color:#fff;font-family:system-ui,Arial}
  #canvas{touch-action:none;display:block;width:100%;height:100%;background:#000}

  /* Painel flutuante */
  #panel{
    position:fixed;top:0;right:0;width:260px;height:100%;
    background:var(--panel);border-left:2px solid #1e293b;
    padding:14px;box-sizing:border-box;
    color:var(--ui);font-size:14px;
    display:flex;flex-direction:column;gap:12px;
  }
  #panel.hidden{display:none;}

  .section-title{font-size:15px;font-weight:bold;margin-bottom:4px;color:#fff}
  .row{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
  input[type=range]{width:140px}
  button{
    background:var(--accent);
    border:none;padding:6px 10px;border-radius:6px;
    color:white;font-weight:bold;cursor:pointer;
  }

  /* Botão fechar */
  #closePanel{
    position:absolute;
    top:8px;
    right:8px;
    background:#d33;
    border:none;
    width:28px;
    height:28px;
    border-radius:4px;
    font-size:20px;
    font-weight:bold;
    cursor:pointer;
    color:white;
  }
</style>
</head>

<body>
<canvas id="canvas"></canvas>

<!-- Painel -->
<div id="panel">
  <button id="closePanel">×</button>

  <div class="section-title">Física</div>

  <div class="row">
    <span>G:</span>
    <input id="gSlider" type="range" min="0.1" max="5" step="0.1" value="1">
    <span id="gVal">1.00</span>
  </div>

  <div class="row">
    <span>dt:</span>
    <input id="dtSlider" type="range" min="0.01" max="0.5" step="0.01" value="0.1">
    <span id="dtVal">0.10</span>
  </div>

  <button id="addPlanet">Adicionar Planeta</button>
  <button id="reset">Resetar</button>
</div>

<script>
/* ================================
   CONFIGURAÇÃO INICIAL
================================ */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { alpha: false });

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* ================================
   SISTEMA DE CÂMERA + ZOOM
================================ */
let camX = 0, camY = 0;
let zoom = 1;
let dragging = false;
let lastTouch = null;
let pinchStartDist = 0;
let startZoom = 1;

canvas.addEventListener("pointerdown", e => {
  dragging = true;
  lastTouch = { x: e.clientX, y: e.clientY };
});
canvas.addEventListener("pointerup", () => dragging = false);
canvas.addEventListener("pointermove", e => {
  if (dragging && lastTouch) {
    camX -= (e.clientX - lastTouch.x) / zoom;
    camY -= (e.clientY - lastTouch.y) / zoom;
    lastTouch = { x: e.clientX, y: e.clientY };
  }
});

/* Pinch Zoom */
canvas.addEventListener("touchstart", ev => {
  if (ev.touches.length === 2) {
    const [t1, t2] = ev.touches;
    pinchStartDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    startZoom = zoom;
  }
}, { passive: false });

canvas.addEventListener("touchmove", ev => {
  if (ev.touches.length === 2) {
    ev.preventDefault();
    const [t1, t2] = ev.touches;
    const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    zoom = Math.min(6, Math.max(0.2, startZoom * (dist / pinchStartDist)));
  }
}, { passive: false });

/* ================================
   OBJETOS / PLANETAS
================================ */
class Body {
  constructor(x,y,m,r,color){
    this.x = x;
    this.y = y;
    this.vx = 0;
    this.vy = 0;
    this.ax = 0;
    this.ay = 0;
    this.m = m;
    this.r = r;
    this.color = color;
    this.rgb = this.hexToRgb(color);
  }
  hexToRgb(h){
    const c = parseInt(h.slice(1),16);
    return [(c>>16)&255,(c>>8)&255,c&255];
  }
}

let bodies = [];
let G = 1.0;
let dt = 0.1;

/* ================================
   FUNÇÃO RESET
================================ */
function resetSystem(){
  bodies = [
    new Body(0,0,2000,20,"#ffff00"),
    new Body(200,0,10,8,"#00aaff"),
    new Body(-250,0,12,8,"#ff0055")
  ];
  bodies[1].vy = 4;
  bodies[2].vy = -3;
}
resetSystem();

/* ================================
   FÍSICA — VELOCITY VERLET
================================ */
function computeAccelerations() {
  for (const b of bodies) {
    b.ax = 0; b.ay = 0;
  }

  for (let i = 0; i < bodies.length; i++) {
    for (let j = i+1; j < bodies.length; j++) {
      const bi = bodies[i], bj = bodies[j];

      let dx = bj.x - bi.x;
      let dy = bj.y - bi.y;
      const eps = 0.001;
      const dist2 = dx*dx + dy*dy + eps;  // CORRIGIDO
      const dist = Math.sqrt(dist2);

      const F = G / dist2;
      const ax = F * dx / dist;
      const ay = F * dy / dist;

      bi.ax += ax * bj.m;
      bi.ay += ay * bj.m;
      bj.ax -= ax * bi.m;
      bj.ay -= ay * bi.m;
    }
  }
}

function stepVerlet(){
  for (const b of bodies) {
    b.vx += b.ax * dt * 0.5;
    b.vy += b.ay * dt * 0.5;

    b.x += b.vx * dt;
    b.y += b.vy * dt;
  }

  computeAccelerations();

  for (const b of bodies) {
    b.vx += b.ax * dt * 0.5;
    b.vy += b.ay * dt * 0.5;
  }
}

/* ================================
   DESENHO
================================ */
function worldToScreenX(x){ return (x - camX) * zoom + canvas.width/2; }
function worldToScreenY(y){ return (y - camY) * zoom + canvas.height/2; }

function draw(){
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  /* Órbitas */
  ctx.lineWidth = 1;

  for (const b of bodies) {
    if (b.m > 200) continue;
    ctx.beginPath();
    ctx.arc(worldToScreenX(b.x), worldToScreenY(b.y), 40 * zoom, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(${b.rgb[0]},${b.rgb[1]},${b.rgb[2]},0.28)`; // CORRIGIDO
    ctx.stroke();
  }

  /* Planetas */
  for (const b of bodies) {
    ctx.beginPath();
    ctx.arc(worldToScreenX(b.x), worldToScreenY(b.y), b.r * zoom, 0, Math.PI*2);
    ctx.fillStyle = `rgb(${b.rgb[0]},${b.rgb[1]},${b.rgb[2]})`;  // CORRIGIDO
    ctx.strokeStyle = `rgba(${b.rgb[0]},${b.rgb[1]},${b.rgb[2]},0.9)`;  // CORRIGIDO
    ctx.fill();
    ctx.stroke();
  }
}

/* ================================
   LOOP PRINCIPAL
================================ */
function loop(){
  stepVerlet();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ================================
   INTERFACE
================================ */
document.getElementById("gSlider").addEventListener("input", e => {
  G = parseFloat(e.target.value);
  document.getElementById("gVal").textContent = G.toFixed(2);
});

document.getElementById("dtSlider").addEventListener("input", e => {
  dt = parseFloat(e.target.value);
  document.getElementById("dtVal").textContent = dt.toFixed(2);
});

document.getElementById("addPlanet").addEventListener("click", () => {
  bodies.push(new Body(
    camX + (Math.random()-0.5)*200,
    camY + (Math.random()-0.5)*200,
    8,
    6,
    "#"+((1<<24)*Math.random()|0).toString(16).padStart(6,"0")
  ));
});

document.getElementById("reset").addEventListener("click", resetSystem);

/* Botão de fechar painel */
document.getElementById("closePanel").addEventListener("click", () => {
  document.getElementById("panel").classList.add("hidden");
});
</script>

</body>
  </html>
